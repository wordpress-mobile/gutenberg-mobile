# frozen_string_literal: true

default_platform :ios

PROJECT_ROOT_FOLDER = File.dirname(File.expand_path(__dir__))

before_all do
  # Ensure we use the latest version of the toolkit
  check_for_toolkit_updates unless is_ci || ENV['FASTLANE_SKIP_TOOLKIT_UPDATE_CHECK']
end

lane :upload_xcframework_to_s3 do |options|
  archive_type = 'tar.gz'
  xcframework_archive_path = File.join(PROJECT_ROOT_FOLDER, "build/xcframeworks/Gutenberg.#{archive_type}")

  unless File.exist? xcframework_archive_path
    UI.user_error! "Could not find XCFramework archive to upload at #{xcframework_archive_path}"
  end

  name = options.fetch(:name, nil)

  if name.nil?
    name = "Gutenberg-#{last_git_commit[:commit_hash]}.#{archive_type}"
    UI.message "No name provide, will default to #{name}"
  end

  upload_xcframework_to_s3(path: xcframework_archive_path, name_on_s3: name)

  next unless is_ci

  tag = ENV.fetch('BUILDKITE_TAG', nil)

  next if tag.nil? || tag.empty?

  upload_xcframework_to_s3(
    path: xcframework_archive_path,
    name_on_s3: "Gutenberg-#{tag}.#{archive_type}"
  )
end

lane :t do
  upload_commit_podspec_to_s3(commit: 'b24b84849081f4d3846f2c1a5868764283be5aad')
end

def upload_xcframework_to_s3(path:, name_on_s3:)
  upload_to_s3(
    bucket: 'a8c-apps-public-artifacts',
    key: name_on_s3,
    file: path,
    auto_prefix: false,
    skip_if_exists: false
  )
end

def upload_commit_podspec_to_s3(commit:)
  # TODO: Read the proper podspec once support for the tag is available and replace the appropriate fields
  podspec = <<~PODSPEC
    # frozen_string_literal: true

    Pod::Spec.new do |s|
      s.name = 'Gutenberg'
      s.version = '1.0.0' # The value here is irrelevant, but required
      s.summary = 'A spec to help integrating the Gutenberg XCFramework'
      s.homepage = 'https://apps.wordpress.com'
      s.license = { type: 'GPL' }
      s.authors = 'Automattic'

      s.ios.deployment_target = '13.0' # TODO: Read from common source
      s.swift_version = '5.0' # TODO: read from common source

      s.requires_arc = true # TODO: Can this be omitted?

      s.source = { http: "https://d2twmm2nzpx3bg.cloudfront.net/Gutenberg-#{commit}.tar.gz"  }

      s.vendored_frameworks = [
        'Frameworks/Aztec.xcframework',
        'Frameworks/Gutenberg.xcframework',
        'Frameworks/React.xcframework',
        'Frameworks/RNTAztecView.xcframework',
        'Frameworks/yoga.xcframework'
      ]
    end
  PODSPEC

  Dir.tmpdir do |tmp_dir|
    podspec_path = File.join(tmp_dir, 'podspec')
    File.open(podspec_path, 'w') do |file|
      file.write(podspec)
    end

    upload_to_s3(
      bucket: 'a8c-apps-public-artifacts',
      key: "Gutenberg-#{commit}.podspec",
      file: podspec_path,
      auto_prefix: false,
      skip_if_exists: false
    )
  end
end
