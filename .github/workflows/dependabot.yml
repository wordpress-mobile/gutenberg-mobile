name: Dependabot auto-merge
on: pull_request_target
permissions:
    pull-requests: write
    contents: write
jobs:
    dependabot:
        runs-on: ubuntu-latest
        if: ${{ github.event.pull_request.user.login == 'dependabot[bot]' }}
        steps:
            - name: Dependabot metadata
              id: dependabot-metadata
              uses: dependabot/fetch-metadata@c9c4182bf1b97f5224aee3906fd373f6b61b4526 # v1.6.0
            - name: Approve the Gutenberg submodule Dependabot PR if not already approved
              if: ${{steps.dependabot-metadata.outputs.dependency-names == 'gutenberg' && steps.dependabot-metadata.outputs.package-ecosystem == 'gitsubmodule'}}
              run: |
                  gh pr checkout "$PR_URL" # sets the upstream metadata for `gh pr status`
                  if [ "$(gh pr status --json reviewDecision -q .currentBranch.reviewDecision)" != "APPROVED" ];
                  then gh pr review --approve "$PR_URL"
                  else echo "PR already approved, skipping additional approvals to minimize emails/notification noise.";
                  fi
              env:
                  PR_URL: ${{github.event.pull_request.html_url}}
                  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
            - name: Enable auto-merge for Gutenberg submodule Dependabot PRs
              if: ${{steps.dependabot-metadata.outputs.dependency-names == 'gutenberg' && steps.dependabot-metadata.outputs.package-ecosystem == 'gitsubmodule'}}
              run: gh pr merge --auto --merge "$PR_URL"
              env:
                  PR_URL: ${{github.event.pull_request.html_url}}
                  GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
